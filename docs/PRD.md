# PRD: Mariem Palantir MVP

## 제품 개요

### 제품명
Mariem Palantir - 미용실 거래 입력 시스템

### 목적
미용실의 모든 거래(시술, 상품, 할인, 정액권, 포인트, 재고)를 **일관된 원장 구조**로 기록한다.

### 핵심 가치
- **입력 정확성**: 거래 시점의 가격/할인 정보를 스냅샷으로 보존
- **확장 가능성**: 분석, 급여 계산 등 후속 기능을 위한 데이터 구조 확보
- **일관성**: 모든 금전 흐름을 원장(ledger) 패턴으로 추적

---

## 사용자 및 역할

| 역할 | 설명 | 주요 기능 |
|------|------|----------|
| OWNER | 매장 소유자 | 모든 기능 접근, 설정 관리 |
| MANAGER | 매니저 | 거래 입력, 마스터 데이터 관리 |
| STYLIST | 스타일리스트 | 거래 입력 (제한적) |

---

## 기능 요구사항

### 1. 마스터 데이터 관리

#### 1.1 서비스 관리
- 서비스 카테고리 CRUD (커트, 펌, 염색, 클리닉 등)
- 서비스 CRUD (이름, 정가, 활성 상태)
- 카테고리별 서비스 목록 조회

#### 1.2 상품 관리
- 공급업체(Vendor) CRUD
- 상품 CRUD
  - 종류: retail(판매용), consumable(소모품), both
  - 용량 정보 (size_value, size_unit)
  - 구매 단가, 판매 단가

#### 1.3 직원 관리
- 직원 CRUD (이름, 직책, 연락처, 활성 상태)
- 기본 수수료율 설정 (향후 급여 계산용)

#### 1.4 정액권 플랜 관리
- 정액권 상품 CRUD
- 판매가(price_paid) vs 충전금액(value_amount)
- 예: 10만원 결제 → 11만원 충전

### 2. 고객 관리

- 고객 CRUD (이름, 연락처, 메모)
- 고객별 포인트 잔액 조회
- 고객별 정액권 잔액 조회
- 고객별 방문 이력 조회

### 3. 거래 입력 (핵심)

#### 3.1 방문(Visit) 생성
- 고객 선택
- 방문 일시 기록
- 상태: draft(임시) → finalized(확정)

#### 3.2 판매 라인(SaleLineItem) 추가
- 시술 또는 상품 선택
- 담당 직원 선택
- 수량 입력
- **자동 가격 계산**:
  - 마스터 정가 로드
  - 적용 가능한 할인 규칙 탐색
  - 할인 적용 후 최종가 계산
  - 모든 금액을 스냅샷으로 저장

#### 3.3 결제(Payment) 추가
- 복수 결제 수단 지원
  - 카드 (card)
  - 현금 (cash)
  - 계좌이체 (bank)
  - 정액권 (prepaid) → 정액권 원장에 사용 기록
  - 포인트 (points) → 포인트 원장에 사용 기록
- 미결제 금액 표시
- 결제 완료 여부 확인

#### 3.4 거래 확정
- 결제 완료 시 확정 가능
- 확정 시 포인트 자동 적립 (포인트 규칙 기반)
- 확정된 거래는 수정 불가

### 4. 가격 규칙

#### 4.1 할인 규칙(PricingRule)
- 규칙 유형: percent(%), amount(원)
- 적용 대상:
  - 전체 서비스
  - 특정 카테고리
  - 특정 서비스
  - 전체 상품
  - 특정 상품
- 유효 기간 (starts_at, ends_at)

#### 4.2 포인트 규칙(PointRule)
- 규칙 유형: percent_of_net(결제금액의 %), fixed(고정)
- 적용 대상 설정
- 유효 기간

### 5. 정액권 원장

#### 5.1 정액권 판매
- 고객에게 정액권 판매 기록
- 판매 직원 기록
- 판매 시점의 플랜 정보 저장

#### 5.2 정액권 사용
- 결제 시 정액권 차감
- FIFO 방식 (오래된 것부터 사용)
- 사용 내역 기록 (방문, 금액)

#### 5.3 잔액 조회
- 고객별 정액권 잔액
- 정액권별 잔액 및 사용 내역

### 6. 포인트 원장

#### 6.1 포인트 적립
- 거래 확정 시 자동 적립
- 포인트 규칙 기반 계산

#### 6.2 포인트 사용
- 결제 시 포인트 차감
- 1포인트 = 1원

#### 6.3 포인트 조정
- 수동 조정 (관리자)
- 메모 기록

#### 6.4 잔액 조회
- 고객별 포인트 잔액
- 포인트 거래 내역

### 7. 재고 관리

#### 7.1 입고 기록
- 공급업체별 입고
- 품목별 수량, 단가

#### 7.2 출고 기록
- 상품 판매 시 자동 출고
- 시술 시 소모품 수동 기록
- 폐기 기록

#### 7.3 재고 조회
- 품목별 현재 재고 (이벤트 합계)
- 재고 이벤트 이력

---

## 비기능 요구사항

### 보안
- 사용자 인증 (Devise)
- 매장별 데이터 격리 (store_id 스코핑)

### 성능
- 페이지네이션 적용
- 인덱스 최적화

### UI/UX
- 반응형 디자인 (Tailwind CSS)
- 한글 지원

---

## 제외 범위 (MVP)

다음 기능은 MVP에서 제외:

- ❌ 순이익 계산
- ❌ 급여/인센티브 자동 계산
- ❌ 재고 원가 평가 (평균법/선입선출)
- ❌ KPI/대시보드
- ❌ 자동 마케팅/메시지
- ❌ 예약 관리
- ❌ 멀티 매장 통합 관리

---

## 성공 지표

1. 모든 거래 유형(시술, 상품, 정액권, 포인트)을 정확히 기록
2. 거래 시점의 가격 정보가 스냅샷으로 보존
3. 원장 합계와 잔액이 일치
4. 확장 가능한 데이터 구조 확보
